# Lambda functions for MOSE
Lambda code for scraping the sensor api. The repository contains code for 3 lambda functions, found in the folders `sensor_data`, `yr_future` and `yr_past`. The last folder `yr_future_from_csv` is a standalone script created to store weather forecasts from yr.no stored in a Excel file via a PowerAutomate script created early in the project to store weather forecast before setting up the Lambda functions and the TimeStream databases. 

To run the lambda functions as standalone scripts, the environment variables must be exported.

On linux exporting vars can be done by:
`export $(cat <env file> | sed '/^#/d' | xargs)`

To export the variables using powershell, check out the documentation [here](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_environment_variables?view=powershell-7.3)

The environment variables can be found in the AWS Secrets Manager in Stockholm (eu-north-1) under `prod/api-scrape-lambda`

All the lambda functions can also be used as a standalone script by exporting correct env variables and running:

```
aws-vault exec <vault-profile> --region=eu-west-1 python lambda_function.py -- <flags>
```
e.g.
```
aws-vault exec mose-timestream --region=eu-west-1 python lambda_function.py -- -d 10 --ids 43 145 
```
The script must be run from the directory of the lambda function. A requirement is that `aws-vault` is set up with the correct profiles, that have access to the different resources need. A detailed guide on how to set up `aws-vault` can be found in the documentation of [AWS Vault](https://github.com/99designs/aws-vault)


 
## Lambda functions
Building of the lambda function can be done by running the script `<folder-name>/package.sh`. As the script uses os-dependent programs, it must be run on a unix-like system or using [WSL](https://learn.microsoft.com/en-us/windows/wsl/install) if using Windows. Before running the script you must download [python 3.9](https://www.python.org/downloads/), and pipenv and create a pipenv environment. Documentation on how to do this can be found [here](https://pipenv.pypa.io/en/latest/)

To deploy the lambda function, upload the zip file generated by the script, to the respective lambda function found in `eu-west-1`. All lambda functions created by this repository starts with the prefix `fetchAndStore`. To upload the zip file, go to 
```
AWS Console region eu-west-1 -> Lambda -> Functions -> fetchAndStore<folder_name_in_pascal_case>
```
Choose the `Code` tab and click `Upload from` and choose `.zip file`. Upload the zip file, and the lambda function is now deployed.
### sensor_data
Fetches data from the sensors defined in [sensor_data/sensor_data.json](sensor_data//sensor_data.json) from [Norbits BlueTrack API](https://bluetrack.norbitiot.com/). The sensors are set up fetching the last 10 minutes by default, as the Norbit sends data to their database on a 5 minute schedule. The lambda function is set up running and fetching data every 9 minutes.

The schema defined in [sensor_data/sensor_data.json](sensor_data/sensor_data.json) describes the dataformat which is expected from the BlueTrack API. Each element in the file should contain the sensor id and recursively define the fields where the data is located.

I.E:

```json
[{"id":1, "data":{
    "sensor_data_1": "BIGINT",
    "sensor_data_2":{
        "sensor_data_2_part_1":"DOUBLE",
        "sensor_data_2_part_2": "VARCHAR",
        "more_custom_data": {...}
        }
    }
},{...}]
```

### yr_future
Fetches data from the [Location Forecast API of yr.no](https://developer.yr.no/doc/locationforecast/HowTO/) and stores the data in a TimeStream database table. Stores forecasted temperature, percipitation, wind speed, wind direction and relative_humidity

### yr_past
Fetching data from the [Frost API by met.no](https://frost.met.no/howto.html). Here a predifined weather station is used, defined in [yr_past/yr_position.json](yr_past/yr_position.json). The weather station used is the one stationed at Berg, Trondheim. Other stations can be added by adding a element to [yr_past/yr_position.json](yr_past/yr_position.json). Station ids can be found by quering the Frost API e.g. by `curl -X GET --header 'Accept: application/json' 'https://frost.met.no/sources/v0.jsonld?geometry=nearest(POINT(10.428%2063.4425))&nearestmaxcount=10'`. An authorization header needs to be set, and keys for this can be genereated by registrating a new user [here](https://frost.met.no/auth/requestCredentials.html)


